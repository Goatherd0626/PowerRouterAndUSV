<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockplot模拟器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .status {
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        .log {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
        }

        .data-container {
            display: flex;
            gap: 20px;
        }

        .data-box {
            flex: 1;
            padding: 10px;
            background-color: #e9e9e9;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>Blockplot海上智能船舶模拟器</h1>
    <div class="container">
        <div class="controls">
            <button id="connectBtn">连接服务器</button>
            <button id="startBtn" disabled>开始仿真</button>
        </div>
        <div class="status" id="status">
            状态: 未连接
        </div>
        <div class="data-container">
            <div class="data-box">
                <h3>船舶数据</h3>
                <div id="shipData">尚无数据</div>
            </div>
            <div class="data-box">
                <h3>充电站数据</h3>
                <div id="cnData">尚无数据</div>
            </div>
        </div>
        <div class="log" id="log">
            <!-- 日志内容会在这里显示 -->
        </div>
    </div>

    <script>
        let socket = null;
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const connectBtn = document.getElementById('connectBtn');
        const startBtn = document.getElementById('startBtn');
        const shipDataEl = document.getElementById('shipData');
        const cnDataEl = document.getElementById('cnData');

        // 添加日志
        function addLog(message) {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div>[${time}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // 连接WebSocket
        connectBtn.addEventListener('click', () => {
            if (socket) {
                socket.close();
                socket = null;
                connectBtn.textContent = '连接服务器';
                startBtn.disabled = true;
                statusEl.textContent = '状态: 未连接';
                addLog('已断开连接');
                return;
            }

            // 创建WebSocket连接
            socket = new WebSocket('ws://pusv.sjtuee.net/ws');

            socket.onopen = () => {
                statusEl.textContent = '状态: 已连接';
                connectBtn.textContent = '断开连接';
                startBtn.disabled = false;
                addLog('WebSocket连接已建立');
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.status) {
                    addLog(`服务器消息: ${data.message}`);
                    return;
                }

                // 处理模拟数据
                if (data.posInfo && data.CNInfo) {
                    // 更新时间
                    statusEl.textContent = `状态: 运行中 - 模拟时间: ${data.time}`;

                    // 更新船舶数据
                    shipDataEl.innerHTML = '<table border="1" style="width:100%; border-collapse: collapse;">' +
                        '<tr><th>ID</th><th>X</th><th>Y</th><th>速度</th><th>电量 (%)</th></tr>' +
                        data.posInfo.map((ship, index) =>
                            `<tr><td>${index}</td><td>${Math.round(ship[0])}</td><td>${Math.round(ship[1])}</td><td>${ship[2].toFixed(2)}</td><td>${(ship[3] / 6643).toFixed(2) * 100}%</td></tr>`
                        ).join('') +
                        '</table>';

                    // 更新充电站数据
                    cnDataEl.innerHTML = '<table border="1" style="width:100%; border-collapse: collapse;">' +
                        '<tr><th>ID</th><th>X</th><th>Y</th><th>储能 (kWh)</th><th>风力 (kW)</th><th>太阳能 (kW)</th></tr>' +
                        data.CNInfo.map((cn, index) =>
                            `<tr><td>${index}</td><td>${Math.round(cn[0])}</td><td>${Math.round(cn[1])}</td><td>${cn[2].toFixed(2)}</td><td>${cn[3].toFixed(2)}</td><td>${cn[4].toFixed(2)}</td></tr>`
                        ).join('') +
                        '</table>';
                }
            };

            socket.onclose = () => {
                statusEl.textContent = '状态: 连接已关闭';
                connectBtn.textContent = '连接服务器';
                startBtn.disabled = true;
                socket = null;
                addLog('WebSocket连接已关闭');
            };

            socket.onerror = (error) => {
                statusEl.textContent = '状态: 连接错误';
                addLog('WebSocket错误: ' + JSON.stringify(error));
            };
        });

        // 开始仿真
        startBtn.addEventListener('click', () => {
            if (!socket) return;

            socket.send('start');
            startBtn.disabled = true;
            addLog('已发送启动命令');
        });
    </script>
</body>

</html>